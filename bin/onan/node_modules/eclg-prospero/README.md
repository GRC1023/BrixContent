Prospero Node
-------------

A node.js library for Prospero to 

* subscribe
* unsubscribe
* publish messages
* receive published messages
* get subscription details


Where to find it
----------------

The repository is at [Github](https://github.com/PearsonEducation/prospero-node) under the [PearsonEducation](https://github.com/PearsonEducation) organization. If you need access, ask Mike Brevoort, Chris Hatton or Chris Skudlarczyk.

You may depend on the module by putting an entry in the <code>devDependencies</code> section of your <code>package.json</code> file with the appropriate version specified after the hash:

    "eclg-prospero": "git+ssh://git@github.com:PearsonEducation/prospero-node.git#v2.1.1",

You may also install the module locally in an ad-hoc fashion by:

    npm install "git+ssh://git@github.com:PearsonEducation/prospero-node.git#v2.1.1"

Usage
-----

After installing the module, you can <code>require</code> it and configure it like so:

	var Prospero = require('eclg-prospero');

	var prosperoConfig = {
	  rootUrl: "http://localhost:4778",
	  principal: "ONE",
	  sharedKey: "1234567890123456",
	  prosperoDefaults: {
        tags: { UserID: "joe" },  // name value pairs --> TAGS
        client: '',               // CLIENT
        clientString: '',         // CLIENT-STRING
        system: '',               // SYSTEM
        subSystem: '',            // SUB-SYSTEM
        realm: '',                // REALM
        payloadContentType: '',   // PAYLOAD-CONTENT-TYPE
	  }
	};

	var p = new Prospero(prosperoConfig);
	
Most of the properties above should be familiar to you if you are using Prosero. The <code>prosperoDefaults</code> object is used as a set of defaults when publishing so that you don't have to continually pass the <code>client</code>, <code>clientString</code>, etc. The comments to the right of each property is the corresponding Prospero property.	

### Result Objects

Called to <code>subscribe</code>, <code>unsubscribe</code>, <code>getSubscription</code>, and <code>publish</code> return the same result object which has two properties: 

* <code>statusCode</code> - HTTP Status code from underlying Prospero call
* <code>data</code> - HTTP body response from the underlying Prospero call

For example a <code>subscribe</code> call result looks like this:

    { 
      statusCode: 200,
      data: { 
        subscription: { 
          id: '75f2a3c0-2cd5-49b0-806f-55ab0614dcda',
          principal_id: 'ONE',
          callback_url: 'http://mycallbackurl.com/a/me',
          wsdl_uri: '',
          queue_name: 'Sub-75f2a3c0-2cd5-49b0-806f-55ab0614dcda',
          date_created: '2012-03-14T03:02:08Z',
          date_cancelled: '',
          tags: [ 
              { 
                tag: { 
                  value: 'Node.Prospero.Test2',
                  id: 'MessageType:Node.Prospero.Test2',
                  type: 'MessageType' 
                } 
              },
              { 
                tag: { 
                  value: 'joe', 
                  id: 'UserID:joe', 
                  type: 'UserID' 
                } 
              },
              length: 2 
          ]
        } 
      } 
    }

### Error Objects

Each of the asyncronous calls that take callback parameters will return an [Error](https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Error) object as a 1st parameter. If there is no error the value of this parameter will be <code>null</code>, otherwise it will most likely be the passed through Error object from the HTTP call to Prospero

### Subscribing

Assuming you've configured the Prospero modude and required it like above, you can subscribe to messages with the <code>subscribe</code> function.

	var options = {
	    messageType: "Node.Prospero.Test",            // MESSAGE-TYPE
	    callbackUrl: "http://mycallbackurl.com/a/me", // CALLBACK-URL
	    tags: { UserID: "joe" }                       // TAGS
	};

	p.subscribe(options, function(error, result) {
		if(error) console.log("Subscription failed!", error);
		
		var subId = result.data.subscription.id;
	});    

Note that if a subscription already exists, the library will get the subscription Id and get <code>getSubscription</code> for you, returning the details of the existing subscription as if you just created it. In this case, Prospero will return a <code>409</code> statusCode but you will see a <code>200</code> statusCode as a result of the secondary GET.

### Unsubscribing

Use the <code>unsubscribe</code> function to unsubscribe: 

	p.subscribe(subscriptionId, function(error, result) {
        error && console.log(error);
        if(data.statusCode === 200)
            console.log("Unsubscribe of " + subId + "sucessful!");
	});
	
If the call is successful, expect a <code>200</code> statusCode. If the subscription is not found, expect a <code>404</code> and if the subscriptionId is invalid you may receive a <code>400</code>.

### Get Subscription by ID

Use the <code>getSubscription</code> function to unsubscribe: 

	getSubscription(subscriptionId, function(error, result) {
        error && console.log(error);
        var subId = result.data.subscription.id;
	});    

Same HTTP statusCodes as <code>unsubscribe</code> applies.


### Publishing

Using the <code>publish</code> function, pass an object as the first parameter and a callback as the second. 

The object passed to publish will be merged with the <code>prosperoDefaults</code>
object specified in the config. Any properties that are passed in here
will override the value in the defaults. Properties like <code>client</code>,
<code>clientString</code>, <code>system</code>, <code>subSystem</code> would be appropriate to set up as defaults. 

Assuming the prospero config above:

     var obj = {
       tags: { UserID: "joe" },  
       messageType: 'Node.Prospero.Test3',
       payloadContentType: 'application/json',
       payload: {
         feeling: 'happy'
       }
     };
     
     p.publish(obj, function(error, result) {
       error && console.log(error);
       if(result.statusCode === 200)
           var messageId = result.data.message.id;
     });



### Receiving a message

Here's an example of setting up a Prospero message receiver with Express. You don't have to use express, but in case you do, the module will gracefully detect if you are using the <code>express.bodyParser()</code>.

The callback of the <code>receive</code> function expects three arguments:

* <code>error</code> - Error object if there was one
* <code>data</code> - the payload of the message, JSON parsed for you if <code>content-type</code> was <code>application/json</code>
* <code>done</code> - a function you **MUST** call to tell Prospero if you accept or reject the message. If you are able to accept the message you call done with no parameters or with a boolean <code>true</code> and an optional response message. If you reject the message and need Prospero to attempt to redeliver it in the future, you call done but with a boolean <code>false</code> like <code>done(false)</code>. If you don't call <code>done()</code> the HTTP connection from Prospero will not be closed!

The example assumes you have a subscription with a callback to <code>http://localhost:8000/receive</code>.

    var express = require('express')
      , Prospero = require('../lib/prospero').Prospero
      , server = express.createServer();
    
    var prosperoConfig = {
      host: "localhost",
      port: 4778,
      principal: "ONE",
      sharedKey: "1234567890123456",
      prosperoDefaults: {}
    };
    
    var p = new Prospero(prosperoConfig);
        
    server.configure(function() {
    	server.use(express.bodyParser()); // optional
    	server.use(server.router);
    });
    
    server.post('/receive', function(req, res) {
    	p.receive(req, res, function(error, data, done) {
    		if(error) {
    			console.log("There was an error!!", error);
    
    			// reject the message by passing false to done
    			return done(false);
    		}
    
    		// do something with data
    		console.log("The message payload was (drum roll) ", data);
    
    		// to accept the message and return 200 to prospero, call
    		// done with no args or true
    		done();
    	};);
    });
    
    server.listen(8000);


Changelog
---------

v2.1.1 *4/11/2012* - aes library cleanup, removed globals and added license header (merged pull request from mac-)

v2.1.0 *3/16/2012* - done() callback on receive now accepts an optional message to be returned to Prospero when a message is rejected. This string appears in the Prospero audit log in the "del_ref" field.

v2.0.0 *3/14/2012* - Major changes to the API, replaced the internal HTTP calls with the request module, added more tests and much more documentation and code comments. 